VAR := $(shell . ./../bin/arch_finder)
DIR := $(shell . ./../bin/dir_finder)

OS := $(shell uname -s)

ifeq ($(strip $(OS)),Darwin)
CPU := $(shell . ./../bin/CPU_DARWIN)
endif	

ifeq ($(strip $(OS)),Linux)
CPU := $(shell . ./../bin/CPU_LINUX)
endif

ifeq ($(strip $(VAR)),)
VAR="'Unknown'"
endif
#FC=mpif90
FCFLAGS= -cpp -funroll-loops -D arch=$(VAR) -D direc=$(DIR) -D cpu=$(CPU)
BUILD_DIR ?= ./../build





#Edit this line to Toggle between "mpi" and "serial" 
#COMMS_ARCH:=mpi



ifeq ($(COMMS_ARCH),mpi)


mandelbrot.mpi: Mandelbrot.o Header.o fractal.o IO.o COMMS_MPI.o
	$(MPI_FC) $(FCFLAGS) -o mandelbrot.mpi Mandelbrot.o COMMS_MPI.o Header.o fractal.o IO.o  -cpp

COMMS_MPI.o: COMMS_MPI.f90
	$(MPI_FC) $(FCFLAGS) -c COMMS_MPI.f90 -cpp

Header.o: Header.f90 COMMS_MPI.o
	$(MPI_FC) $(FCFLAGS) -c Header.f90 COMMS_MPI.o -cpp

fractal.o: fractal.f90
	$(MPI_FC) $(FCFLAGS) -c fractal.f90 -cpp

IO.o: IO.f90
	$(MPI_FC) $(FCFLAGS) -c IO.f90 -cpp



Mandelbrot.o: Mandelbrot.f90 Header.o fractal.o IO.o COMMS_MPI.o
	$(MPI_FC) $(FCFLAGS) -c Mandelbrot.f90 -cpp



endif


ifeq ($(COMMS_ARCH),serial)

mandelbrot.serial: Mandelbrot.o Header.o fractal.o IO.o COMMS_MPI.o
	$(SERIAL_FC) $(FCFLAGS) -o mandelbrot.serial Mandelbrot.o COMMS_SERIAL.o Header.o fractal.o IO.o  -cpp

Header.o: Header.f90 COMMS_SERIAL.o
	$(SERIAL_FC) $(FCFLAGS) -c Header.f90 COMMS_SERIAL.o -cpp

fractal.o: fractal.f90
	$(SERIAL_FC) $(FCFLAGS) -c fractal.f90 -cpp

IO.o: IO.f90
	$(SERIAL_FC) $(FCFLAGS) -c IO.f90 -cpp

COMMS_SERIAL.o: COMMS_MPI.f90
	$(SERIAL_FC) $(FCFLAGS) -c COMMS_SERIAL.f90 -cpp


Mandelbrot.o: Mandelbrot.f90 Header.o fractal.o IO.o COMMS_SERIAL.o
	$(SERIAL_FC) $(FCFLAGS) -c Mandelbrot.f90 -cpp




endif